<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Proxy</title>
</head>
<body style="margin:0;padding:0;background:transparent;">
    <div id="card"></div>
    <script>
        // URL에서 username 파라미터 가져오기
        const params = new URLSearchParams(window.location.search);
        const username = params.get('username') || 'tlqhrm';
        
        // 색상 함수들
        const getStreakColor = (streak) => {
            if (streak >= 20) return '#22c55e';
            if (streak >= 10) return '#3b82f6';
            if (streak >= 5) return '#8b5cf6';
            return '#64748b';
        };
        
        const getSuccessRateColor = (rate) => {
            if (rate >= 90) return '#22c55e';
            if (rate >= 70) return '#3b82f6';
            if (rate >= 50) return '#f59e0b';
            return '#ef4444';
        };
        
        // 데이터 가져오기 및 카드 생성
        fetch(`https://raw.githubusercontent.com/${username}/weekly-commit-challenge/master/record.json`)
            .then(response => {
                if (!response.ok) throw new Error('Not found');
                return response.json();
            })
            .then(data => {
                if (data.records && data.records.length > 0) {
                    const records = data.records;
                    let currentStreak = 0;
                    let maxStreak = 0;
                    let tempStreak = 0;
                    let successWeeks = 0;
                    
                    // 최신부터 역순으로 현재 연속 계산
                    for (let i = records.length - 1; i >= 0; i--) {
                        if (records[i].success) {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }
                    
                    // 최장 연속 계산
                    for (const record of records) {
                        if (record.success) {
                            tempStreak++;
                            maxStreak = Math.max(maxStreak, tempStreak);
                            successWeeks++;
                        } else {
                            tempStreak = 0;
                        }
                    }
                    
                    const successRate = Math.round((successWeeks / records.length) * 100);
                    const totalWeeks = records.length;
                    
                    const streakColor = getStreakColor(currentStreak);
                    const rateColor = getSuccessRateColor(successRate);
                    
                    // SVG 카드 생성
                    const svg = `<svg width="400" height="130" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<defs>
    <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" style="stop-color:#1e293b;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#0f172a;stop-opacity:1" />
    </linearGradient>
    <style>
        .title { font: 600 18px 'Segoe UI', Ubuntu, sans-serif; fill: #f1f5f9; }
        .subtitle { font: 400 12px 'Segoe UI', Ubuntu, sans-serif; fill: #94a3b8; }
        .label { font: 400 11px 'Segoe UI', Ubuntu, sans-serif; fill: #94a3b8; }
        .value { font: 600 16px 'Segoe UI', Ubuntu, sans-serif; }
        .small-value { font: 500 13px 'Segoe UI', Ubuntu, sans-serif; }
    </style>
</defs>

<a xlink:href="https://tlqhrm.github.io/weekly-commit-challenge/" target="_blank">
    <rect width="400" height="130" rx="6" fill="url(#grad)"/>
    <rect x="1" y="1" width="398" height="128" rx="5" fill="none" stroke="#334155" stroke-width="1"/>
    
    <g transform="translate(25, 25)">
        <text class="title" y="0">Weekly Commit Challenge</text>
        <text class="subtitle" y="20">${username}</text>
    </g>
    
    <g transform="translate(25, 65)">
        <g transform="translate(0, 0)">
            <text class="label" y="0">Current Streak</text>
            <text class="value" y="20" fill="${streakColor}">${currentStreak} weeks</text>
        </g>
        
        <g transform="translate(120, 0)">
            <text class="label" y="0">Success Rate</text>
            <text class="value" y="20" fill="${rateColor}">${successRate}%</text>
        </g>
        
        <g transform="translate(220, 0)">
            <text class="label" y="0">Total Weeks</text>
            <text class="small-value" y="20" fill="#64748b">${totalWeeks}</text>
        </g>
        
        <g transform="translate(300, 0)">
            <text class="label" y="0">Max Streak</text>
            <text class="small-value" y="20" fill="#8b5cf6">${maxStreak}</text>
        </g>
    </g>
    
    <g transform="translate(25, 115)">
        <rect width="350" height="4" rx="2" fill="#1e293b"/>
        <rect width="${Math.min(350 * successRate / 100, 350)}" height="4" rx="2" fill="${rateColor}"/>
    </g>
</a>
</svg>`;
                    
                    document.getElementById('card').innerHTML = svg;
                } else {
                    throw new Error('No records found');
                }
            })
            .catch(error => {
                // 에러 시 기본 카드
                const errorSvg = `<svg width="400" height="130" xmlns="http://www.w3.org/2000/svg">
    <rect width="400" height="130" rx="6" fill="#1e293b"/>
    <text x="200" y="65" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="14">
        No data found for ${username}
    </text>
</svg>`;
                document.getElementById('card').innerHTML = errorSvg;
            });
    </script>
</body>
</html>