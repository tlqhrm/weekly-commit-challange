<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Commit Challenge Card Generator</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f6f8fa;
        }
        h1 {
            color: #24292e;
        }
        .generator-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        input {
            width: 300px;
            padding: 8px 12px;
            border: 1px solid #d1d5da;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            padding: 8px 16px;
            background: #0366d6;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
        }
        button:hover {
            background: #0256c7;
        }
        .preview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .code-block {
            background: #f6f8fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            text-align: left;
            overflow-x: auto;
        }
        .download-btn {
            background: #28a745;
            margin-top: 10px;
        }
        .download-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <h1>Weekly Commit Challenge Card Generator</h1>
    
    <div class="generator-form">
        <h2>카드 생성하기</h2>
        <input type="text" id="username" placeholder="GitHub 사용자명 입력" />
        <button onclick="generateCard()">카드 생성</button>
    </div>
    
    <div class="preview" id="preview" style="display: none;">
        <h2>미리보기</h2>
        <div id="cardContainer"></div>
        <button class="download-btn" onclick="downloadSVG()">SVG 다운로드</button>
        
        <h3>README에 추가하기</h3>
        <div class="code-block" id="readmeCode"></div>
    </div>
    
    <script>
        let currentSVG = '';
        
        function generateCard() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('사용자명을 입력해주세요');
                return;
            }
            
            // 색상 함수
            const getStreakColor = (streak) => {
                if (streak >= 20) return '#22c55e';
                if (streak >= 10) return '#3b82f6';
                if (streak >= 5) return '#8b5cf6';
                return '#64748b';
            };
            
            const getSuccessRateColor = (rate) => {
                if (rate >= 90) return '#22c55e';
                if (rate >= 70) return '#3b82f6';
                if (rate >= 50) return '#f59e0b';
                return '#ef4444';
            };
            
            // record.json 가져오기
            fetch(`https://raw.githubusercontent.com/${username}/weekly-commit-challenge/master/record.json`)
                .then(response => {
                    if (!response.ok) throw new Error('Not found');
                    return response.json();
                })
                .then(data => {
                    if (data.records && data.records.length > 0) {
                        const records = data.records;
                        let currentStreak = 0;
                        let maxStreak = 0;
                        let tempStreak = 0;
                        let successWeeks = 0;
                        
                        // 최신부터 역순으로 현재 연속 계산
                        for (let i = records.length - 1; i >= 0; i--) {
                            if (records[i].success) {
                                currentStreak++;
                            } else {
                                break;
                            }
                        }
                        
                        // 최장 연속 계산
                        for (const record of records) {
                            if (record.success) {
                                tempStreak++;
                                maxStreak = Math.max(maxStreak, tempStreak);
                                successWeeks++;
                            } else {
                                tempStreak = 0;
                            }
                        }
                        
                        const successRate = records.length > 0 ? Math.round((successWeeks / records.length) * 100) : 0;
                        const totalWeeks = records.length;
                        
                        const streakColor = getStreakColor(currentStreak);
                        const rateColor = getSuccessRateColor(successRate);
                        
                        // SVG 생성
                        currentSVG = `<svg width="400" height="130" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<defs>
    <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" style="stop-color:#1e293b;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#0f172a;stop-opacity:1" />
    </linearGradient>
    <style>
        .title { font: 600 18px 'Segoe UI', Ubuntu, sans-serif; fill: #f1f5f9; }
        .subtitle { font: 400 12px 'Segoe UI', Ubuntu, sans-serif; fill: #94a3b8; }
        .label { font: 400 11px 'Segoe UI', Ubuntu, sans-serif; fill: #94a3b8; }
        .value { font: 600 16px 'Segoe UI', Ubuntu, sans-serif; }
        .small-value { font: 500 13px 'Segoe UI', Ubuntu, sans-serif; }
    </style>
</defs>

<a xlink:href="https://tlqhrm.github.io/weekly-commit-challenge/" target="_blank">
    <rect width="400" height="130" rx="6" fill="url(#grad)"/>
    <rect x="1" y="1" width="398" height="128" rx="5" fill="none" stroke="#334155" stroke-width="1"/>
    
    <g transform="translate(25, 25)">
        <text class="title" y="0">Weekly Commit Challenge</text>
        <text class="subtitle" y="20">${username}</text>
    </g>
    
    <g transform="translate(25, 65)">
        <g transform="translate(0, 0)">
            <text class="label" y="0">Current Streak</text>
            <text class="value" y="20" fill="${streakColor}">${currentStreak} weeks</text>
        </g>
        
        <g transform="translate(120, 0)">
            <text class="label" y="0">Success Rate</text>
            <text class="value" y="20" fill="${rateColor}">${successRate}%</text>
        </g>
        
        <g transform="translate(220, 0)">
            <text class="label" y="0">Total Weeks</text>
            <text class="small-value" y="20" fill="#64748b">${totalWeeks}</text>
        </g>
        
        <g transform="translate(300, 0)">
            <text class="label" y="0">Max Streak</text>
            <text class="small-value" y="20" fill="#8b5cf6">${maxStreak}</text>
        </g>
    </g>
    
    <g transform="translate(25, 115)">
        <rect width="350" height="4" rx="2" fill="#1e293b"/>
        <rect width="${Math.min(350 * successRate / 100, 350)}" height="4" rx="2" fill="${rateColor}"/>
    </g>
</a>
</svg>`;
                        
                        document.getElementById('cardContainer').innerHTML = currentSVG;
                        document.getElementById('readmeCode').textContent = 
                            `![Weekly Commit Challenge](https://raw.githubusercontent.com/tlqhrm/weekly-commit-challenge/master/cards/user-${username}.svg)`;
                        document.getElementById('preview').style.display = 'block';
                    } else {
                        throw new Error('No records found');
                    }
                })
                .catch(error => {
                    alert(`사용자 '${username}'의 데이터를 찾을 수 없습니다. Weekly Commit Challenge에 참여하고 있는지 확인해주세요.`);
                });
        }
        
        function downloadSVG() {
            const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `weekly-commit-challenge-${document.getElementById('username').value}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Enter 키로도 생성 가능
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                generateCard();
            }
        });
    </script>
</body>
</html>